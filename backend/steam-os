#!/bin/bash

case $1 in
	pre)
		killall steam

		# We wait for Steam to go away
		# Try 5 times, since we might be waiting for cloud sync
		for i in $(seq 1 5)
		do
			if pgrep -f steam.sh > /dev/null
			then
				sleep 2
				echo "$i time waiting for Steam to shutdown"
			fi
		done

		sleep 1

		killall -9 steam
		;;
	post)
		# If we don't sleep, things go wrong sometimes
		# I wish I had a better way of doing this
		sleep 1

		# We are going to wait here until there is an X Server responding
		while ! xset -q > /dev/null 2>&1
		do
			sleep 2
			echo "There is no X server that we can connect to."
		done

		# We are guessing that whoever owns PulseAudio owns the display
		xuser=$(stat -c %U /proc/"$(pgrep -f pulseaudio)")

		# We assume that Alt-S is a keybind for launching Steam
		sudo -u "$xuser" bash -c "export DISPLAY=:0 ; xdotool keydown Alt key s keyup Alt"
		;;
esac
